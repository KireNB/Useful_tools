import tkinter as tk
from tkinter import simpledialog, filedialog, messagebox
from PIL import Image, ImageTk, ImageDraw
import random
import time
import pygame
import os

CARD_SIZE = 120
ROWS = 4
COLS = 4
FLIP_SPEED = 15  # Geschwindigkeit der Flip-Animation

# Sound-Dateien
FLIP_SOUND = "sounds/flip.wav"
MATCH_SOUND = "sounds/match.wav"
FAIL_SOUND = "sounds/fail.wav"

pygame.mixer.init()

def play_sound(path):
    if os.path.exists(path):
        pygame.mixer.Sound(path).play()

# Hilfsfunktion für abgerundete Bilder
def round_corners(im, rad):
    circle = Image.new('L', (rad * 2, rad * 2), 0)
    draw = ImageDraw.Draw(circle)
    draw.ellipse((0, 0, rad * 2, rad * 2), fill=255)
    alpha = Image.new('L', im.size, 255)
    w, h = im.size
    alpha.paste(circle.crop((0,0,rad,rad)), (0,0))
    alpha.paste(circle.crop((0,rad,rad,rad*2)), (0,h-rad))
    alpha.paste(circle.crop((rad,0,rad*2,rad)), (w-rad,0))
    alpha.paste(circle.crop((rad,rad,rad*2,rad*2)), (w-rad,h-rad))
    im.putalpha(alpha)
    return im

class MemoryGame:
    def __init__(self, root):
        self.root = root
        self.root.title("Modernes Memory")
        self.root.configure(bg="#2E3440")
        self.flipped_cards = []
        self.lock = False
        self.cards = []
        self.buttons = []

        self.show_menu()

    def show_menu(self):
        self.menu_frame = tk.Frame(self.root, bg="#3B4252", padx=30, pady=30)
        self.menu_frame.pack(expand=True)

        tk.Label(self.menu_frame, text="Memory Spiel", font=("Arial", 24, "bold"), bg="#3B4252", fg="white").pack(pady=10)
        self.player1_entry = tk.Entry(self.menu_frame, font=("Arial", 14))
        self.player1_entry.insert(0, "Spieler 1")
        self.player1_entry.pack(pady=5)
        self.player2_entry = tk.Entry(self.menu_frame, font=("Arial", 14))
        self.player2_entry.insert(0, "Spieler 2")
        self.player2_entry.pack(pady=5)

        tk.Button(self.menu_frame, text="Bilder auswählen", font=("Arial", 12), bg="#81A1C1", fg="black", command=self.select_images).pack(pady=10)
        self.start_btn = tk.Button(self.menu_frame, text="Spiel starten", font=("Arial", 14), bg="#A3BE8C", fg="black", command=self.start_game)
        self.start_btn.pack(pady=20)

        self.image_paths = []

    def select_images(self):
        paths = filedialog.askopenfilenames(title="8 Bilder auswählen", filetypes=[("PNG/JPG", "*.png *.jpg")])
        if len(paths) != 8:
            messagebox.showerror("Fehler", "Bitte genau 8 Bilder auswählen!")
        else:
            self.image_paths = list(paths)
            messagebox.showinfo("Erfolg", "Bilder erfolgreich geladen!")

    def start_game(self):
        self.player_names = [self.player1_entry.get(), self.player2_entry.get()]
        if not self.player_names[0] or not self.player_names[1]:
            messagebox.showerror("Fehler", "Beide Spielernamen müssen angegeben werden!")
            return
        if len(self.image_paths) != 8:
            messagebox.showerror("Fehler", "Bitte 8 Bilder auswählen!")
            return

        self.menu_frame.destroy()
        self.scores = [0,0]
        self.current_player = 0
        self.load_images()
        self.create_scoreboard()
        self.create_board()
        self.create_ingame_menu()

    def load_images(self):
        self.back_image = round_corners(Image.open("images/back.png").resize((CARD_SIZE, CARD_SIZE)), 20)
        self.back_photo = ImageTk.PhotoImage(self.back_image)

        images = [round_corners(Image.open(p).resize((CARD_SIZE, CARD_SIZE)), 20) for p in self.image_paths]
        self.card_images = images * 2
        random.shuffle(self.card_images)

    def create_scoreboard(self):
        self.score_frame = tk.Frame(self.root, bg="#2E3440")
        self.score_frame.pack(pady=10)
        self.score_label = tk.Label(self.score_frame, text=self.get_status_text(), font=("Arial", 14), bg="#2E3440", fg="white")
        self.score_label.pack()

    def get_status_text(self):
        return (f"{self.player_names[0]}: {self.scores[0]}    |    "
                f"{self.player_names[1]}: {self.scores[1]}    "
                f"(Am Zug: {self.player_names[self.current_player]})")

    def create_board(self):
        self.board_frame = tk.Frame(self.root, bg="#2E3440")
        self.board_frame.pack(pady=10)
        self.buttons = []
        self.cards = []

        for i in range(ROWS*COLS):
            btn = tk.Label(self.board_frame, image=self.back_photo, bd=0, bg="#2E3440", relief="raised")
            btn.grid(row=i//COLS, column=i%COLS, padx=8, pady=8)
            btn.bind("<Button-1>", lambda e, idx=i: self.on_card_click(idx))
            self.buttons.append(btn)
            self.cards.append({"image": self.card_images[i], "matched": False})

    def create_ingame_menu(self):
        self.ingame_menu = tk.Menu(self.root)
        self.root.config(menu=self.ingame_menu)
        game_menu = tk.Menu(self.ingame_menu, tearoff=0)
        game_menu.add_command(label="Neustart", command=self.restart)
        game_menu.add_command(label="Beenden", command=self.root.quit)
        self.ingame_menu.add_cascade(label="Spiel", menu=game_menu)

    def restart(self):
        self.root.destroy()
        os.system("python " + __file__)

    def on_card_click(self, index):
        if self.lock or self.cards[index]["matched"] or index in self.flipped_cards:
            return
        play_sound(FLIP_SOUND)
        self.flip_card(index)
        self.flipped_cards.append(index)
        if len(self.flipped_cards) == 2:
            self.lock = True
            self.root.after(700, self.check_match)

    def flip_card(self, index):
        img = self.cards[index]["image"]
        self.animate_flip(self.buttons[index], img)

    def animate_flip(self, widget, front_image):
        # Einfacher Flip-Effekt
        widget.config(image=ImageTk.PhotoImage(front_image))
        widget.image = ImageTk.PhotoImage(front_image)

    def check_match(self):
        i1,i2 = self.flipped_cards
        img1 = self.cards[i1]["image"]
        img2 = self.cards[i2]["image"]

        if img1 == img2:
            self.cards[i1]["matched"] = True
            self.cards[i2]["matched"] = True
            self.scores[self.current_player] +=1
            play_sound(MATCH_SOUND)
        else:
            self.hide_card(i1)
            self.hide_card(i2)
            play_sound(FAIL_SOUND)
            self.current_player = 1 - self.current_player

        self.flipped_cards=[]
        self.lock=False
        self.score_label.config(text=self.get_status_text())
        if all(card["matched"] for card in self.cards):
            self.end_game()

    def hide_card(self,index):
        self.buttons[index].config(image=self.back_photo)

    def end_game(self):
        if self.scores[0] > self.scores[1]:
            winner = self.player_names[0]
        elif self.scores[1] > self.scores[0]:
            winner = self.player_names[1]
        else:
            winner = "Unentschieden"
        messagebox.showinfo("Spiel beendet", f"Gewinner: {winner}")
        self.root.quit()


if __name__=="__main__":
    root = tk.Tk()
    MemoryGame(root)
    root.mainloop()
